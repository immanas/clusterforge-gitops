apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: nginx-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.25
        ports:
        - containerPort: 80
- name: Update deployment image tag
  run: |
    sed -i "s|image:.*|image: ${{ secrets.DOCKER_USERNAME }}/clusterforge-nginx:${{ github.sha }}|" apps/nginx/deployment.yaml

- name: Commit changes
  run: |
    git config user.name github-actions
    git config user.email github-actions@github.com
    git add .
    git commit -m "Update image to ${{ github.sha }}" || echo "No changes"
    git push
